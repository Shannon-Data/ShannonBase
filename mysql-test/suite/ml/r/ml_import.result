DROP DATABASE IF EXISTS ML_SCHEMA_root;
SET GLOBAL local_infile = 1;
DROP DATABASE IF EXISTS shannon_ml;
CREATE DATABASE shannon_ml;
ALTER DATABASE shannon_ml CHARACTER SET ascii COLLATE ascii_bin;
USE shannon_ml;
CREATE TABLE census_train (
age INT,
workclass VARCHAR(255),
fnlwgt INT,
education VARCHAR(255),
`education-num` INT,
`marital-status` VARCHAR(255),
occupation VARCHAR(255),
relationship VARCHAR(255),
race VARCHAR(255),
sex VARCHAR(255),
`capital-gain` INT,
`capital-loss` INT,
`hours-per-week` INT,
`native-country` VARCHAR(255),
revenue VARCHAR(255)
);
CREATE TABLE census_test LIKE census_train;
SET @census_model = 'census_test_im';
ALTER TABLE census_train SECONDARY_LOAD;
CALL sys.ML_TRAIN('shannon_ml.census_train', 'revenue', JSON_OBJECT('task', 'classification'), @census_model);
SET @shml_model = "census_test_im";
CREATE TABLE imported_from_tb (
chunk_id INT AUTO_INCREMENT PRIMARY KEY,
model_object LONGTEXT NOT NULL,
model_metadata JSON DEFAULT NULL
);
INSERT INTO imported_from_tb (model_object, model_metadata)
SELECT moc.model_object, mc.model_metadata FROM ML_SCHEMA_root.MODEL_OBJECT_CATALOG moc
JOIN ML_SCHEMA_root.MODEL_CATALOG mc ON moc.model_handle = mc.model_handle WHERE moc.model_handle = @shml_model
ORDER BY moc.chunk_id;
SET @imported_model = 'census_test_imported';
CALL sys.ML_MODEL_IMPORT(NULL, JSON_OBJECT('schema', 'shannon_ml', 'table', 'imported_from_tb'), @imported_model);
SELECT MODEL_ID, MODEL_HANDLE, MODEL_OBJECT, MODEL_OWNER, 
JSON_UNQUOTE(MODEL_METADATA->'$.task') AS task, JSON_UNQUOTE(MODEL_METADATA->'$.column_names') as feature_names
FROM ML_SCHEMA_root.MODEL_CATALOG;
MODEL_ID	MODEL_HANDLE	MODEL_OBJECT	MODEL_OWNER	task	feature_names
1	census_test_im	NULL	root	CLASSIFICATION	["age", "workclass", "fnlwgt", "education", "education-num", "marital-status", "occupation", "relationship", "race", "sex", "capital-gain", "capital-loss", "hours-per-week", "native-country"]
2	census_test_imported	NULL	root	CLASSIFICATION	["age", "workclass", "fnlwgt", "education", "education-num", "marital-status", "occupation", "relationship", "race", "sex", "capital-gain", "capital-loss", "hours-per-week", "native-country"]
SELECT CHUNK_ID, MODEL_HANDLE from ML_SCHEMA_root.MODEL_OBJECT_CATALOG;
CHUNK_ID	MODEL_HANDLE
1	census_test_im
1	census_test_imported
SELECT MODEL_ID, ML_SCHEMA_root.MODEL_CATALOG.MODEL_HANDLE, ML_SCHEMA_root.MODEL_CATALOG.MODEL_OBJECT, MODEL_OWNER, 
JSON_UNQUOTE(MODEL_METADATA->'$.task') AS task, JSON_UNQUOTE(MODEL_METADATA->'$.column_names') as feature_names
FROM  ML_SCHEMA_root.MODEL_CATALOG, ML_SCHEMA_root.MODEL_OBJECT_CATALOG
WHERE ML_SCHEMA_root.MODEL_CATALOG.MODEL_HANDLE = ML_SCHEMA_root.MODEL_OBJECT_CATALOG.MODEL_HANDLE;
MODEL_ID	MODEL_HANDLE	MODEL_OBJECT	MODEL_OWNER	task	feature_names
1	census_test_im	NULL	root	CLASSIFICATION	["age", "workclass", "fnlwgt", "education", "education-num", "marital-status", "occupation", "relationship", "race", "sex", "capital-gain", "capital-loss", "hours-per-week", "native-country"]
2	census_test_imported	NULL	root	CLASSIFICATION	["age", "workclass", "fnlwgt", "education", "education-num", "marital-status", "occupation", "relationship", "race", "sex", "capital-gain", "capital-loss", "hours-per-week", "native-country"]
DROP DATABASE IF EXISTS ML_SCHEMA_root;
ALTER TABLE census_train SECONDARY_UNLOAD;
DROP DATABASE IF EXISTS shannon_ml;
